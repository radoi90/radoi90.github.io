<!DOCTYPE html>
<html lang="en">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0;">
	<title>HouseQuest - The best way to find your house in London</title>

	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
	<link href='http://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="css/bootstrap-tagsinput.css">
	<link rel="stylesheet" href="css/animate.css">

	<!-- Latest compiled and minified JavaScript -->
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
	<script src="js/jquery-1.11.1.min.js" type="text/javascript"></script>
	<script src="js/underscore.js"></script>
	<script src="js/tagmanager.js" type="text/javascript"></script>
	<script src="http://www.parsecdn.com/js/parse-1.2.13.min.js"></script>

	<link rel="stylesheet" href="css/welcome.css" type="text/css">

	<link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>

	<script>
 		$( document ).ready(function() {
 			jQuery(".tm-input").tagsManager({
		        CapitalizeFirstLetter: true,
		        hiddenTagListName: "entry_922244654",
		        hiddenTagListId: "entry.922244654"
		    });

 			var input = $("input[name='entry_922244654']");
 			input.id = "entry.922244654"

			$("#options-panel").hide();
		}); 
    </script>

	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','http://www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-37859939-3', 'auto');
	  ga('send', 'pageview');
	</script>
</head>
<body>
	<div id="propertyapp" class="overlay">
		<!-- Navbar -->
		<nav class="navbar navbar-default" role="navigation">
		  <div class="container-fluid animated fadeInDown">

		    <!-- Brand and toggle get grouped for better mobile display -->
		    <div class="navbar-header">
			  <div class="navbar-brand">House<span class="Q">Q</span>uest</div>
		      <button type="button" class="btn-flat btn-login-mini btn-orange" onclick="loginButtonPressed();">Login</button>
		    </div>

		    <!-- Collect the nav links, forms, and other content for toggling -->
		    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
		      <ul class="nav navbar-nav">
		      	<li><a class="title hidden-xs" href="#">House<span class="Q">Q</span>uest</a></li>
		      	<li class="pull-right">
		      		<button type="button" class="btn-flat btn-orange" onclick="loginButtonPressed();">Login</button>
		      	</li>
		      </ul>
		    </div><!-- /.navbar-collapse -->
		  </div><!-- /.container-fluid -->
		</nav>

		<div id="options-panel">
			
		</div>

		<!-- Form -->
		<form class="form-horizontal" id="user-form" role="form" action="https://docs.google.com/forms/d/1RvngjKApBx-h7Z8r-xBIMWWK9H98T-oXke4fqxErvHU/formResponse" method="post"
				target="hidden_iframe" onsubmit="return checkSubmit();">

			<!-- Main page -->
			<div class="container location-form">
					<div id="banner-text" class="animated fadeIn">
						Let us do your rental search
					</div>
					<div id="banner-text-sub" class="animated fadeIn">
						Curated property lists and viewing arrangements
					</div>
					<div id="action-box" class="centered animated fadeIn">
						<div id="where-box" >
							<div id="where">
								Where?	
							</div>					
							<!-- <label for="entry_922244654" class="control-label">Location (City, borough, street, postcode)</label>
									<textarea class="form-control" name="entry.922244654" id="entry_922244654" rows="2" placeholder="E.g. Clerkenwell or NW1, near Northern line stations"></textarea> -->
						  <input type="text" placeholder="Islington, Shoreditch..." class="tm-input"/>
						</div>
						<div id="btn-find-container">
							<button type="button" class="btn-flat btn-green btn-find" onclick="advanceLocationForm();">Find my property</button>
						</div>
					</div>
			</div>

			<div class="container personal-info-form">
				<div class="row-fluid">
					<script type="text/javascript">var submitted=false;</script>
					<!-- <iframe name="hidden_iframe" id="hidden_iframe"
					style="display:none;"></iframe> -->
						<div class="col-sm-8  col-sm-offset-2" id="personal-form">
							<h2 class="text-center">Tell us about yourself</h2>

							<div class="form-group">
								<div class="col-sm-6">
									<label for="entry_495151048" class="control-label" style="font-weight: 0;">First name*</label>					
									<input placeholder="Bob" type="text" class="form-control" name="entry.495151048" id="entry_495151048" required>
								</div>

								<div class="col-sm-6">
									<label for="entry_1489655683" class="control-label">Last name*</label>
									<input placeholder="Smith" type="text" class="form-control" name="entry.1489655683" id="entry_1489655683" required>
								</div>	
							</div>						

							<div class="form-group">
								<div class="col-sm-6">
									<label for="entry_1866180113" class="control-label">Email*</label>
									<input placeholder="bob@bobsmith.com" type="email" class="form-control" name="entry.1866180113" id="entry_1866180113" required>
								</div>

								<div class="col-sm-6">
									<label for="entry_1066742705" class="control-label">Phone</label>
									<input placeholder="01234 567890" ype="text" class="form-control" name="entry.1066742705" id="entry_1066742705">
								</div>						
							</div>

							<div class="form-group">
								<div class="col-sm-6">
									<label for="entry_893950790" class="control-label">Current employer / school*</label>
									<input placeholder="Bob Industries Inc." type="text" class="form-control" name="entry.893950790" id="entry_893950790" required>
								</div>

								<div class="col-sm-6">
									<label for="entry_1534924529" class="control-label">When can you attend viewings?</label>
							 		<input placeholder="Mon-Fri 6:30-8" type="text" class="form-control" name="entry.1534924529" id="entry_1534924529">
								</div>
							</div>

							<div class="form-group text-center">
								<button class="btn-flat btn-green btn-next" onclick="advancePersonalForm();">Next</button>
							</div>

						</div>
				</div>
			</div>

			<div class="container property-info-form">
				<div class="row-fluid">
					<script type="text/javascript">var submitted=false;</script>
					<iframe name="hidden_iframe" id="hidden_iframe"
					style="display:none;"></iframe>
					
						<div class="col-sm-8  col-sm-offset-2" id="property-form">
							<h2 class="text-center">What are you looking for?</h2>
							<div class="form-group">
								<div class="col-sm-6">
									<label for="entry_935209026" class="control-label">Bedrooms</label>
									<select class="form-control" name="entry.935209026" id="entry_935209026">
										<option value="No min">No min</option> <option value="Studio">Studio</option>
										<option value="1+">1+</option> <option value="2+">2+</option>
										<option value="3+">3+</option> <option value="4+">4+</option>
									</select>
								</div>

								<div class="col-sm-6">
									<label for="entry_1452370776" class="control-label">Max price (per month)</label>
									<select class="form-control" name="entry.1452370776" id="entry_1452370776" >
										<option value="0">No max</option>
									    <option value="100" >&pound;100 pcm</option>
									    <option value="200" >&pound;200 pcm</option>
									    <option value="300" >&pound;300 pcm</option>
									    <option value="400" >&pound;400 pcm</option>
									    <option value="500" >&pound;500 pcm</option>
									    <option value="600" >&pound;600 pcm</option>
									    <option value="700" >&pound;700 pcm</option>
									    <option value="800" >&pound;800 pcm</option>
									    <option value="900" >&pound;900 pcm</option>
									    <option value="1000" >&pound;1,000 pcm</option>
									    <option value="1250" >&pound;1,250 pcm</option>
									    <option value="1500" >&pound;1,500 pcm</option>
									    <option value="1750" >&pound;1,750 pcm</option>
									    <option value="2000" >&pound;2,000 pcm</option>
									    <option value="2250" >&pound;2,250 pcm</option>
									    <option value="2500" >&pound;2,500 pcm</option>
									    <option value="2750" >&pound;2,750 pcm</option>
									    <option value="3000" >&pound;3,000 pcm</option>
									    <option value="3250" >&pound;3,250 pcm</option>
									    <option value="3500" >&pound;3,500 pcm</option>
									    <option value="3750" >&pound;3,750 pcm</option>
									    <option value="4000" >&pound;4,000 pcm</option>
									    <option value="4250" >&pound;4,250 pcm</option>
									    <option value="4500" >&pound;4,500 pcm</option>
									    <option value="4750" >&pound;4,750 pcm</option>
									    <option value="5000" >&pound;5,000 pcm</option>
									    <option value="5500" >&pound;5,500 pcm</option>
									    <option value="6000" >&pound;6,000 pcm</option>
									    <option value="6500" >&pound;6,500 pcm</option>
									    <option value="7000" >&pound;7,000 pcm</option>
									    <option value="7500" >&pound;7,500 pcm</option>
									    <option value="8000" >&pound;8,000 pcm</option>
									    <option value="8500" >&pound;8,500 pcm</option>
									    <option value="9000" >&pound;9,000 pcm</option>
									    <option value="9500" >&pound;9,500 pcm</option>
									    <option value="10000" >&pound;10,000 pcm</option>
									    <option value="12500" >&pound;12,500 pcm</option>
									    <option value="15000" >&pound;15,000 pcm</option>
									    <option value="17500" >&pound;17,500 pcm</option>
									    <option value="20000" >&pound;20,000 pcm</option>
									    <option value="25000" >&pound;25,000 pcm</option>
									</select>
								</div>
							</div>

							<div class="form-group">
								<div class="col-sm-6">
									<label for="entry_562686023" class="control-label" >Property type</label>
									<select class="form-control" name="entry.562686023" id="entry_562686023" >
										<option value="Any">Any</option>
										<option value="Houses">Houses</option>
										<option value="Flats">Flats</option>
									</select>
								</div>

								
								<div class="col-sm-6">
									<label for="entry_488055055" class="control-label">Furniture</label>
									<select class="form-control" name="entry.488055055" id="entry_488055055" >
										<option value="Show all">Show all</option> 
										<option value="Furnished">Furnished</option>
										<option value="Part furnished">Part furnished</option>
										<option value="Unfurnished">Unfurnished</option>
									</select>
								</div>
							</div>

							<div class="form-group">
								<div class="col-sm-6">
									<label for="entry_1052293236" class="control-label">Earliest move in date</label>
									<input class="form-control" type="date" name="entry.1052293236" id="entry_1052293236" >
								</div>

								<div class="col-sm-6">
									<label for="entry_79946928" class="control-label">Latest move in date</label>
									<input class="form-control" type="date" name="entry.79946928" id="entry_79946928" >
								</div>
							</div>

							<div class="form-group text-center">
								<button type="submit" class="btn-flat btn-green btn-next" onclick="advancePropertyForm()">Submit</button>
							</div>
						
						</div>
					<br><br>
				</div>
			</div>

			<div class="container success-form">
				<script type="text/javascript">var submitted=true;</script>
				<div id="success-box">
					<div id="success-box-solid">
						<div id="thumb">
							<img src="./img/thumb.png" width="20%" height="20%" />
						</div>
						<div id="awesome">Awesome!</div>
							<div id="line">
								<img src="./img/line.png">
							</div>
						<div id="awesome-sub-text">
							Sit back and relax. <br/>
							We'll handle it from here.<br/><br/>

							Stay tuned for an email when we get your feed up and running.
						</div>
					</div>
				</div>
			</div>
		</form>
	</div>
</body>

<!-- Scripts -->
<script type="text/template" id="login-template">
	<form class="login-form">
  		<div class="error" style="display:none"></div>
        <div class="success" style="display:none"></div>
		<label class="login-label">Email</label>		
		<input placeholder="Email" type="email" id="login-email" class="login-control">
		<label class="login-label">Password</label>		
		<input placeholder="Password" type="password" id="login-password" class="login-control">
		<button id="btn-login" class="btn btn-flat btn-green">
			Login
		</button>
	</form>
</script>

<script type="text/javascript">
	var pageIndex = 0;
	var onPersonal = true;

	// $('#user-form').submit(function(event){
	// 	if (onPersonal) {
	// 		event.preventDefault();
	// 		console.log("prevented!");
	// 	}
	// });

	function loginButtonPressed() {
		$("#options-panel").toggle();
	}

	function advanceLocationForm() {
		onPersonal = true;
		console.log("Checking locations");
		var location = $("input[name='entry_922244654']");

		var input = $(".tm-input").val()
		console.log(input)
		if (input) {
			location.val(location.val() + ", " + input);
			console.log(location.val())
		};

		if (!location.val() == "") {
			pageIndex = 1;
			$('.location-form').addClass('animated bounceOutLeft');
			$('.personal-info-form').addClass('animated bounceInRight');
			$('.personal-info-form').css('display', 'block');
		} else {
			$("#action-box").css("overflow", "visible");
			$("#where-box").addClass('animated tada');
			setTimeout(function() {
		        $("#where-box").removeClass('animated tada');
		        $("#action-box").css("overflow", "hidden");
		    }, 1000);
		}
	}

	function advancePersonalForm() {
		var fname = document.getElementById("entry_495151048").value;
		var sname = document.getElementById("entry_1489655683").value;
		var email = document.getElementById("entry_1866180113").value;
		var password = document.getElementById("entry_1066742705").value;
		var phone = document.getElementById("entry_893950790").value;
		var employer = document.getElementById("entry_1534924529").value;

		if (!(fname == "" || sname == "" || email == "" || !validateEmail(email) || password == "" || phone == "" || employer == "")) {
			console.log("advancing");
			pageIndex = 2;
			$('.personal-info-form').addClass('animated bounceOutLeft');
			$('.property-info-form').addClass('animated bounceInRight'); 
			$('.property-info-form').css('display', 'block');
		} else {
			console.log("Can't advance");
		}
	}

	function advancePropertyForm() {
		onPersonal = false;
		var beds = document.getElementById("entry_935209026").value;
		var price = document.getElementById("entry_1452370776").value;
		var proptype = document.getElementById("entry_562686023").value;
		var furniture = document.getElementById("entry_488055055").value;
		var earliestmovein = document.getElementById("entry_1052293236").value;
		var latestmovein = document.getElementById("entry_79946928").value;

		// if (!(earliestmovein == "" || latestmovein == "")) {
			$('.property-info-form').addClass('animated bounceOutLeft');
			$('.success-form').addClass('animated bounceInRight'); 
			$('.success-form').css('display', 'block');
		// }
	}

	$('#user-form').bind("keyup keypress", function(e) {
		var code = e.keyCode || e.which; 
		if (code == 13) {      
			console.log("preventing!!")         ;
			e.preventDefault();
			return false;
		if (Parse.User.current()) {
			var reqACL = new Parse.ACL(Parse.User.current());
      reqACL.setRoleReadAccess("Administrator",true);
      reqACL.setRoleWriteAccess("Administrator",true);

      var Requirements = Parse.Object.extend("Requirements");
			var requirements = new Requirements();
			 
			requirements.set("user", Parse.User.current());
			requirements.set("ACL", reqACL);
			requirements.set("num_bedrooms", $("#signup-num_bedrooms").val());
			requirements.set("pcm", $("#signup-pcm").val());
			requirements.set("date_min", $("#signup-date_min").val());
			requirements.set("date_max", $("#signup-date_max").val());
			requirements.set("other", $("#signup-other").val());
			
			 
			requirements.save(null, {
			  success: function(requirements) {
			    $('.property-info-form').addClass('animated bounceOutLeft');
					$('.success-form').addClass('animated bounceInRight'); 
					$('.success-form').css('display', 'block');
			  }
			});
		}
	}

	function validateEmail(email) { 
    	var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    	return re.test(email);
	}

	$(function() {

		Parse.$ = jQuery;

		// Initialize Parse with your Parse application javascript keys
		Parse.initialize("5ITlOKP4A8ggw5KYLJnsHYyOoQ9CZydXeUDSqjiQ",
		               "lsm1ZGuKXFw1PLaU6WYHHSLN2o2V6FQd8675nfmi");

		var LogInView = Parse.View.extend({
		    events: {
		      "submit form.login-form": "logIn",
		      "click a.reset-password": "resetPassword"
		    },

		    el: "#options-panel",
		    
		    initialize: function() {
		      _.bindAll(this, "logIn");
		      this.render();
		    },

		    logIn: function(e) {
		      var self = this;
		      var email = this.$("#login-email").val();
		      var password = this.$("#login-password").val();
		      
		      Parse.User.logIn(email, password, {
		        success: function(user) {
		          window.location.href = 'feed.html';
		        },

		        error: function(user, error) {
		          self.$(".login-form .success").hide();  
		          self.$(".login-form .error").html("Invalid email or password. Please try again. Or, <a class='reset-password'>reset password</a>.").show();
		          self.$(".login-form button").removeAttr("disabled");
		        }
		      });

		      this.$(".login-form button").attr("disabled", "disabled");

		      return false;
		    },

		    resetPassword: function() {
		      var email = this.$("#login-email").val();

		      Parse.User.requestPasswordReset(email, {
		        success: function() {
		          self.$(".login-form .success").html("We've sent you a password reset email to " + email).show();
		          self.$(".login-form .error").hide();
		        },
		        error: function(error) {
		          self.$(".login-form .success").hide();
		          if(email.length > 0) {
		            self.$(".login-form .error").html("There is no user assigned to " + email).show();
		          } else {
		            self.$(".login-form .error").html("To reset your password enter the email you used to sign up.").show();
		          }          
		          self.$(".login-form button").removeAttr("disabled");
		        }
		      });
		    },

		    render: function() {
		      this.$el.html(_.template($("#login-template").html()));
		      this.delegateEvents();
		    }
		});

		var ResetPasswordView = Parse.View.extend({
		    events: {
		      "submit form.login-form": "resetPassword",
		      "click a.reset-password": "logIn"
		    },

		    el: "#options-panel",
		    
		    initialize: function() {
		      _.bindAll(this, "logIn", "resetPassword");
		      this.render();
		    },

		    resetPassword: function(e) {
				var self = this;
				var email = this.$("#login-email").val();

				Parse.User.requestPasswordReset(email, {
					success: function() {
					  self.$(".login-form .error").hide();
					  self.$(".login-form .success").html("Check your email for instructions.").show();
					  self.$(".reset-message").hide();
					  self.$("#login-email").hide();
					  self.$("#btn-login").hide();
					},
					error: function(error) {
					  if(email.length > 0) {
					    self.$(".login-form .error").html("There is no user assigned to " + email).show();
					  }

					  self.$(".login-form button").removeAttr("disabled");
					}
				});

				this.$(".login-form button").attr("disabled", "disabled");

		        return false;
		    },

		    logIn: function() {
		    	var self = this;
		    	
		    	new LogInView();
		    	self.undelegateEvents();
          		delete self;
		    },

		    render: function() {
		      this.$el.html(_.template($("#resetPassword-template").html()));
		      this.delegateEvents();
		    }
		});

		// The main view for the app
		var AppView = Parse.View.extend({
			// Instead of generating a new element, bind to the existing skeleton of
			// the App already present in the HTML.
			el: $("#propertyapp"),

			initialize: function() {
			  this.render();
			},

			render: function() {
			  if (Parse.User.current()) {
			    console.log(Parse.User.current());
			  } else {
			    new LogInView();
			  }
			}
		});

		new AppView;
	});

	function checkSubmit() {
		if (onPersonal) {
			console.log("Preventing submission");
			return false;
		} else {
			console.log("allowing submission");
			return true;
		};
	}
</script>
</html>
